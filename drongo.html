<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DRONGO AUTONOMOUS - Official Receipt</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* A very light blue background */
        }
        
        #receiptPreview {
            font-family: 'Roboto Mono', monospace;
        }

        .receipt-container {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .receipt-line {
            border-bottom: 1px dashed #cbd5e1;
        }
        .receipt-total {
            border-top: 2px solid #334155;
            border-bottom: 2px solid #334155;
        }
        .watermark {
            position: absolute; 
            opacity: 0.06; 
            font-size: 4rem;
            font-weight: 700; 
            color: #0d9488; /* Teal color for watermark */
            transform: rotate(-30deg); 
            z-index: 0; 
            pointer-events: none;
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) rotate(-30deg);
        }
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #14b8a6;
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        #qr-reader-container #qr-reader {
            border: 2px solid #14b8a6 !important;
            border-radius: 12px;
        }
        #notificationModal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .notification-success { background-color: #10b981; }
        .notification-error { background-color: #f43f5e; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; margin: 0; padding: 0; }
            .receipt-container-wrapper { margin: 0; padding: 0; }
            .receipt-container { 
                box-shadow: none; 
                border-radius: 0;
                width: 100% !important;
                max-width: 100% !important;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-600 mb-2">DRONGO AUTONOMOUS</h1>
            <p class="text-slate-500">Electronic Receipt Generator</p>
        </div>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Receipt Form -->
            <div class="bg-white rounded-xl shadow-sm p-6 lg:col-span-2 no-print self-start border border-gray-200">
                <h2 class="text-xl font-semibold text-slate-800 mb-6 border-b pb-3">Receipt Details</h2>

                <div class="space-y-4">
                    
                    <div class="p-3 border border-dashed border-gray-300 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-camera-retro mr-2 text-teal-500"></i>Capture Sales Data from Photo
                        </label>
                        <input id="photoInput" type="file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 cursor-pointer" />
                        <div id="ocrStatus" class="text-xs text-gray-500 mt-2 h-4 flex items-center"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                        <input id="customerName" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input id="customerPhone" type="tel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ID Number</label>
                        <div class="flex items-center gap-2">
                            <input id="customerId" type="text" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" />
                            <label for="idCaptureInput" class="flex-shrink-0 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-3 rounded-lg cursor-pointer transition">
                                <i class="fas fa-id-card"></i>
                            </label>
                            <input id="idCaptureInput" type="file" accept="image/*" class="hidden" />
                        </div>
                        <div id="idOcrStatus" class="text-xs text-gray-500 mt-1 h-4 flex items-center"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Receipt No.</label>
                        <input id="receiptNumber" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-slate-50 cursor-not-allowed" readonly />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input id="receiptDate" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Served By</label>
                        <input id="user" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Enter your name" />
                    </div>

                    <div class="pt-4">
                        <h3 class="font-medium text-gray-700 mb-2">Items</h3>
                        <div id="itemsContainer" class="space-y-3"></div>
                        <button id="addItemBtn" class="mt-3 w-full flex items-center justify-center py-2 px-4 bg-teal-50 text-teal-600 rounded-lg hover:bg-teal-100 transition font-semibold">
                            <i class="fas fa-plus mr-2"></i> Add Item
                        </button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="notes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-4">
                        <button id="generateBtn" class="col-span-2 bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-4 rounded-lg font-medium transition flex items-center justify-center shadow-sm hover:shadow-md">
                            <i class="fas fa-receipt mr-2"></i> Generate & Save
                        </button>
                        <button id="printBtn" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg font-medium transition flex items-center justify-center no-print">
                            <i class="fas fa-print mr-2"></i> Print
                        </button>
                        <button id="downloadBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-4 rounded-lg font-medium transition flex items-center justify-center no-print">
                            <i class="fas fa-download mr-2"></i> Download Image
                        </button>
                         <button id="newSaleBtn" class="col-span-2 bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-lg font-medium transition flex items-center justify-center no-print">
                            <i class="fas fa-sync-alt mr-2"></i> New Sale
                        </button>
                    </div>
                </div>
            </div>

            <!-- Receipt Preview -->
            <div class="lg:col-span-3 receipt-container-wrapper flex justify-center items-start">
                <div id="receiptPreview" class="receipt-container bg-white relative w-full max-w-sm text-slate-800">

                    <div class="watermark">DRONGO</div>

                    <div class="text-center p-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-slate-900">DRONGO AUTONOMOUS</h2>
                        <p class="text-xs text-slate-500">PHONE & ACCESSORIES</p>
                        <p class="text-xs text-slate-500">Tel: 0708 255 099 | Email: drongokenya@gmail.com</p>
                        <p class="text-xs text-slate-500">PIN: A007191573N</p>
                    </div>

                    <div class="p-4 text-xs">
                        <div class="flex justify-between mb-2">
                            <span>Receipt No: <b id="previewReceiptNo" class="text-slate-900">1</b></span>
                            <span id="previewDate">05/07/2025</span>
                        </div>
                        <div class="flex justify-between mb-4">
                            <span>Served By: <b id="previewUser" class="text-slate-900"></b></span>
                            <span id="previewTime">11:13 AM</span>
                        </div>

                        <div class="mb-4 bg-slate-50 p-2 rounded-md">
                            <p>Customer: <b id="previewCustomer" class="text-sm text-slate-900">John Doe</b></p>
                            <p>Phone: <span id="previewPhone">+254 700 000 000</span></p>
                            <p>ID: <span id="previewId"></span></p>
                        </div>

                        <div class="flex font-bold receipt-line pb-1 mb-1 text-slate-600">
                            <div class="flex-grow">ITEM</div>
                            <div class="w-12 text-right">QTY</div>
                            <div class="w-20 text-right">TOTAL</div>
                        </div>
                        
                        <div id="previewItems" class="text-xs"></div>
                        
                        <div id="totalsContainer" class="mt-4 pt-2 font-bold text-slate-800"></div>

                        <div class="mt-4 pt-2 border-t border-dashed border-gray-300">
                            <p class="font-bold mb-1 text-slate-600">Notes:</p>
                            <p id="previewNotes" class="text-xs text-slate-500"></p>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-200 text-center text-xs text-slate-500">
                            <p class="font-bold mt-2 text-slate-600">Thank you and come back again</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Scan IMEI Barcode</h3>
                <button id="closeScannerBtn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div id="qr-reader-container">
                <div id="qr-reader" class="w-full"></div>
            </div>
            <p id="scannerStatus" class="text-center text-sm text-slate-600 mt-4"></p>
        </div>
    </div>

    <!-- Custom Notification Modal -->
    <div id="notificationModal" class="fixed top-5 right-5 p-4 rounded-lg text-white font-semibold shadow-lg z-[100] opacity-0 -translate-y-10 pointer-events-none">
        <span id="notificationMessage"></span>
    </div>


    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- URLs and Constants ---
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwYlY5Mvy6ALnCxtP1GlgoJGI3wMQqFT2QowWr-mTYvgARZs1T8sH9napnjDS1t09UX/exec';
        const GEMINI_PROXY_URL = 'https://gemini-proxy-server-7qvm.onrender.com/gemini-proxy';

        // --- Custom Notification Function ---
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        let notificationTimeout;

        function showNotification(message, type = 'success') {
            clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            notificationModal.className = `fixed top-5 right-5 p-4 rounded-lg text-white font-semibold shadow-lg z-[100] opacity-100 translate-y-0 pointer-events-auto ${type === 'success' ? 'notification-success' : 'notification-error'}`;

            notificationTimeout = setTimeout(() => {
                notificationModal.classList.replace('opacity-100', 'opacity-0');
                notificationModal.classList.replace('translate-y-0', '-translate-y-10');
                notificationModal.classList.add('pointer-events-none');
            }, 3000);
        }

        // --- AI DATA EXTRACTION FUNCTIONALITY ---
        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        async function handleImageUpload(file, prompt, statusElement, populateFunction) {
            if (!file) return;
            statusElement.innerHTML = '<div class="loader mr-2"></div> Processing...';
            try {
                const imagePart = await fileToGenerativePart(file);
                const payload = { contents: [{ parts: [{ text: prompt }, imagePart] }] };
                const response = await fetch(GEMINI_PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'AI processing failed.');
                }
                const data = await response.json();
                populateFunction(data);
                statusElement.textContent = '✅ Data extracted successfully!';
                updateReceiptPreview();
            } catch (error) {
                console.error('AI Extraction Error:', error);
                statusElement.textContent = `❌ Error: ${error.message}`;
            }
        }

        document.getElementById('photoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const prompt = `Analyze the attached image of a product box or sales agreement. Extract the following details: customerName (if present), customerPhone (if present), and a list of items. For each item, extract the model (product name/description), imei (the IMEI number), and price. Respond with a single, clean JSON object with the keys 'customerName', 'customerPhone', and 'items' (which should be an array of objects). Example: { "customerName": "John Doe", "customerPhone": "0712345678", "items": [{"model": "Samsung A52", "imei": "123456789012345", "price": 35000}] }`;
            const statusElement = document.getElementById('ocrStatus');
            const populateSalesData = (data) => {
                if (data.customerName) document.getElementById('customerName').value = data.customerName;
                if (data.customerPhone) document.getElementById('customerPhone').value = data.customerPhone;
                if (data.items && Array.isArray(data.items) && data.items.length > 0) {
                    const itemsContainer = document.getElementById('itemsContainer');
                    itemsContainer.innerHTML = '';
                    data.items.forEach(item => addItemRow(item.model, item.imei, item.price));
                }
            };
            handleImageUpload(file, prompt, statusElement, populateSalesData);
        });

        document.getElementById('idCaptureInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const prompt = `From the image of the ID card, extract only the ID Number. Respond with a single, clean JSON object with the key 'idNumber'. Example: { "idNumber": "12345678" }`;
            const statusElement = document.getElementById('idOcrStatus');
            const populateIdData = (data) => {
                if (data.idNumber) document.getElementById('customerId').value = data.idNumber;
            };
            handleImageUpload(file, prompt, statusElement, populateIdData);
        });

        // --- BARCODE SCANNER FUNCTIONALITY ---
        const scannerModal = document.getElementById('scannerModal');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        const scannerStatus = document.getElementById('scannerStatus');
        let html5QrCode;
        let activeImeiInput = null;

        function onScanSuccess(decodedText, decodedResult) {
            if (activeImeiInput) {
                activeImeiInput.value = decodedText;
                updateReceiptPreview();
            }
            stopScanner();
        }

        function onScanFailure(error) { /* Be quiet on failure */ }
        
        function startScanner(imeiInput) {
            activeImeiInput = imeiInput;
            scannerModal.classList.remove('hidden');
            if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            scannerStatus.textContent = "Requesting camera permissions...";
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess, onScanFailure)
                .then(() => { scannerStatus.textContent = "Point camera at the barcode"; })
                .catch(err => { scannerStatus.textContent = "Error: Could not start camera."; });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
            }
            scannerModal.classList.add('hidden');
        }

        closeScannerBtn.addEventListener('click', stopScanner);
        
        // --- RECEIPT NUMBER LOGIC ---
        const receiptInput = document.getElementById('receiptNumber');
        async function fetchLastReceiptNumber() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                const result = await response.json();
                const last = result.last_receipt;
                const currentYear = new Date().getFullYear();
                const match = last.match(/DA-(\d{4})-(\d+)/); 
                const nextNum = match ? parseInt(match[2]) + 1 : 1;
                const next = `DA-${currentYear}-${String(nextNum).padStart(3, '0')}`;
                receiptInput.value = next;
            } catch (error) {
                console.error("❌ Failed to fetch receipt number:", error);
                receiptInput.value = `DA-${new Date().getFullYear()}-001`;
            }
            updateReceiptPreview();
        }
        
        // --- INITIALIZATION ---
        fetchLastReceiptNumber();
        document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
        
        function addItemRow(desc = '', imei = '', price = 0) {
            const itemId = Date.now();
            const itemHtml = `
                <div class="item-row bg-slate-50 p-3 rounded-lg" data-id="${itemId}">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-center">
                        <div class="md:col-span-4"><input type="text" placeholder="Phone Model" class="item-desc w-full px-3 py-1 border border-gray-300 rounded-md text-sm" value="${desc}"></div>
                        <div class="md:col-span-3 flex items-center">
                            <input type="text" placeholder="IMEI" class="item-imei w-full px-3 py-1 border border-gray-300 rounded-l-md text-sm" value="${imei}">
                            <button class="scan-btn bg-slate-200 hover:bg-slate-300 p-2 rounded-r-md" title="Scan Barcode">
                                <i class="fas fa-barcode"></i>
                            </button>
                        </div>
                        <div class="md:col-span-1"><input type="number" placeholder="Qty" class="item-qty w-full px-3 py-1 border border-gray-300 rounded-md text-sm" value="1" min="1"></div>
                        <div class="md:col-span-2"><input type="number" placeholder="Price" class="item-price w-full px-3 py-1 border border-gray-300 rounded-md text-sm" value="${price || ''}" min="0" step="0.01"></div>
                        <div class="md:col-span-2 flex items-center justify-end">
                            <button class="remove-item text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', itemHtml);
            updateReceiptPreview();
        }

        // --- UI EVENT LISTENERS ---
        document.getElementById('addItemBtn').addEventListener('click', () => addItemRow());
        
        document.getElementById('itemsContainer').addEventListener('click', function (e) {
            if (e.target.closest('.scan-btn')) {
                startScanner(e.target.closest('.scan-btn').previousElementSibling);
            } else if (e.target.closest('.remove-item')) {
                e.target.closest('.item-row').remove();
                updateReceiptPreview();
            }
        });
        
        const formInputs = ['customerName', 'customerPhone', 'customerId', 'receiptNumber', 'receiptDate', 'user', 'notes'];
        formInputs.forEach(id => document.getElementById(id).addEventListener('input', updateReceiptPreview));
        document.getElementById('itemsContainer').addEventListener('input', updateReceiptPreview);
        
        document.getElementById('printBtn').addEventListener('click', () => window.print());
        
        document.getElementById('downloadBtn').addEventListener('click', function () {
            const receipt = document.getElementById('receiptPreview');
            let customerName = (document.getElementById('customerName').value.trim() || 'receipt').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            let imei = '';
            const firstImeiInput = document.querySelector('.item-imei');
            if (firstImeiInput && firstImeiInput.value) {
                imei = '_' + firstImeiInput.value.trim().replace(/[^a-z0-9]/gi, '');
            }
            html2canvas(receipt, { scale: 3, logging: false, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${customerName}${imei}_receipt.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });

        document.getElementById('newSaleBtn').addEventListener('click', function() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerId').value = '';
            document.getElementById('user').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('itemsContainer').innerHTML = '';
            addItemRow();
            fetchLastReceiptNumber();
        });
        
        document.getElementById('generateBtn').addEventListener('click', function () {
            updateReceiptPreview();
            const items = [];
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const amount = qty * price;
                total += amount;
                items.push({
                    model: row.querySelector('.item-desc').value || 'Item',
                    imei: row.querySelector('.item-imei').value || '',
                    qty, price, amount
                });
            });

            const payload = items.map(item => ({
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                id: document.getElementById('customerId').value,
                user: document.getElementById('user').value,
                model: item.model,
                imei: item.imei,
                qty: item.qty,
                price: item.price,
                amount: item.amount,
                total: total,
                date: document.getElementById('receiptDate').value,
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }),
                receipt_no: document.getElementById('receiptNumber').value
            }));

            fetch(GOOGLE_SHEET_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(res => {
                    showNotification('✅ Receipt saved successfully!');
                    fetchLastReceiptNumber();
                })
                .catch(err => {
                    showNotification(`❌ Failed to save receipt. ${err.message}`, 'error');
                });
        });
        
        function updateReceiptPreview() {
            document.getElementById('previewCustomer').textContent = document.getElementById('customerName').value || 'N/A';
            document.getElementById('previewPhone').textContent = document.getElementById('customerPhone').value || 'N/A';
            document.getElementById('previewId').textContent = document.getElementById('customerId').value || 'N/A';
            document.getElementById('previewReceiptNo').textContent = document.getElementById('receiptNumber').value || 'N/A';

            const dateInput = document.getElementById('receiptDate').value;
            const now = new Date();
            if (dateInput) {
                const date = new Date(dateInput);
                const adjustedDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                document.getElementById('previewDate').textContent = adjustedDate.toLocaleDateString('en-GB');
            } else {
                document.getElementById('previewDate').textContent = now.toLocaleDateString('en-GB');
            }

            document.getElementById('previewTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            document.getElementById('previewUser').textContent = document.getElementById('user').value || 'N/A';
            document.getElementById('previewNotes').textContent = document.getElementById('notes').value || 'None';

            const itemsContainer = document.getElementById('previewItems');
            itemsContainer.innerHTML = '';
            let subtotal = 0;
            const itemRows = document.querySelectorAll('.item-row');

            itemRows.forEach(row => {
                const desc = row.querySelector('.item-desc').value || 'Item';
                const imei = row.querySelector('.item-imei').value || '';
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const amount = qty * price;
                subtotal += amount;

                const itemHtml = `
                    <div class="receipt-line py-1.5">
                        <div class="flex">
                            <div class="flex-grow">${desc}</div>
                            <div class="w-12 text-right">${qty}</div>
                            <div class="w-20 text-right font-semibold">${amount.toLocaleString('en-US')}</div>
                        </div>
                        ${imei ? `<div class="text-slate-500 pt-0.5">IMEI: ${imei}</div>` : ''}
                    </div>`;
                itemsContainer.insertAdjacentHTML('beforeend', itemHtml);
            });

            if (itemRows.length === 0) {
                itemsContainer.innerHTML = `<div class="text-center text-slate-500 py-2">No items added.</div>`;
            }

            document.getElementById('totalsContainer').innerHTML = `
                <div class="flex justify-between receipt-total py-2 text-sm">
                    <span>GROSS TOTAL</span>
                    <span>Ksh ${subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                </div>`;
        }
        
        addItemRow();
        updateReceiptPreview();
    });
    </script>
</body>
</html>
